<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Canvas Interaction</title>
  <style>
    body {
      width: 100%;
      height: 100vh;
      max-height: 100vh;

      /* width: 1000px;
      height: 1000px; */

      align-items: center;
      text-align: center;

      background-color: black;
      /* width: 100%;
      height: 100%; */

      overflow: hidden;
    }
    canvas {

      margin: 500px auto;

      image-rendering: pixelated;
      transform-origin: middle center;

      transform: scale(16);
    }
    #overlay {
      position: absolute;
      z-index: 99;

        /*
      margin-top: 1px;
      margin-left: 1px;*/

      pointer-events: none;

      border: 1px solid black;
      box-shadow: 0 0 8px 4px white;
    }


    #overlay2 {
      position: absolute;
      z-index: 99;

      pointer-events: none;

      border: 1px solid black;
      box-shadow: 0 0 8px 4px black;


      width: 30px;
      height: 30px;
      top: 500px;
      left: 500px;
    }


    .color-box {
      width: 56px;
      height: 32px;
      border: 2px solid black;
      cursor: pointer;
    }
    .color-box.active {
      border-color: white;
    }
    .menu {
      position: fixed;
      bottom: 0;
      width: 100%;
      pointer-events: none;
    }
    .menu-content {
      margin: auto;
      pointer-events: all;
      background-color: red;
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    .menu-text {
      background-color: blue;
      width: 160px;
      text-align: center;
    }
    .color-selection {
      background-color: green;
      padding: 10px;
      display: flex;
      gap: 10px;
    }
  </style>
</head>
<body>

<canvas id="placeCanvas" width="50px" height="50px"></canvas>
<div id="overlay"></div>
<div id="overlay2"></div>

<div class="menu">
  <div class="menu-content">
    <div class="menu-text">text</div>
    <div class="color-selection" id="colorSelection"></div>
  </div>
</div>

<script>
  document.addEventListener('DOMContentLoaded', function () {
    const canvas = document.getElementById('placeCanvas');
    const overlay = document.getElementById('overlay');
    const overlay2 = document.getElementById('overlay2');
    const colorSelection = document.getElementById('colorSelection');
    
    const ctx = canvas.getContext('2d');
    let ratio = 16;
    let translate = { x: 0, y: 0 };
    let activePixel = { x: -1, y: -1 };
    let dragStart = { x: -1, y: -1 };
    let isDragging = 0;
    let zoom = true;
    let activeColor = -1;
    let colors = new Map();
    let board = new Map();
    
    function renderOverlay() {
      const centerX = canvas.width / 2;
      const centerY = canvas.height / 2;

      const offsetX = (canvas.offsetLeft - (centerX * ratio) + centerX);
      const offsetY = (canvas.offsetTop - (centerY * ratio) + centerY);
      // const offsetY = canvas.offsetTop;

      const tx = ((activePixel.x * ratio) + offsetX) + translate.x * ratio;
      const ty = ((activePixel.y * ratio) + offsetY) + translate.y * ratio;

      overlay.style.width = `${ratio - 2}px`;
      overlay.style.height = `${ratio - 2}px`;
      overlay.style.top = `${ty}px`;
      overlay.style.left = `${tx}px`;

      overlay2.style.width = `${ratio * 2 - 2}px`;
      overlay2.style.height = `${ratio * 2 - 2}px`;
      // overlay2.style.top = `${offsetY + (centerY * ratio - ratio)}px`;
      // overlay2.style.left = `${offsetX + (centerX * ratio - ratio)}px`;

      overlay2.style.top = `${offsetY + (centerY + translate.y) * ratio}px`;
      overlay2.style.left = `${offsetX + (centerX + translate.x) * ratio}px`;
    }

    function renderCanvas() {
      // ctx.scale(20, 20);
      // ctx.draw();

      canvas.style.transform = `scale(${ratio}) translate(${translate.x}px, ${translate.y}px)`;
    }

    function setColor(color, id) {
      
      const colorBox = document.createElement('div');
      colorBox.className = 'color-box';
      colorBox.style.backgroundColor = `rgb(${color.color})`;
      colorBox.innerHTML = color.name;
      colorBox.addEventListener('click', () => {
        activeColor = id;
        document.querySelectorAll('.color-box').forEach(box => box.classList.remove('active'));
        colorBox.classList.add('active');
      });
      colorSelection.appendChild(colorBox);
    }

    window.addEventListener('resize', (e) => {
      renderCanvas();
      renderOverlay();
    });
    renderCanvas();
    renderOverlay();

    canvas.addEventListener('click', (e) => {
      const rect = canvas.getBoundingClientRect();
      const offsetX = rect.left + translate.x * ratio;
      const offsetY = rect.top + translate.y * ratio;

      const clickedX = Math.floor((e.pageX - offsetX) / ratio + translate.x);
      const clickedY = Math.floor((e.pageY - offsetY) / ratio + translate.y);

      console.log(clickedX, clickedY)
      
      activePixel = { x: clickedX, y: clickedY };
      // const overlayX = clickedX * ratio + translate.x * ratio;
      // const overlayY = clickedY * ratio + translate.y * ratio;

      renderOverlay();
    });

    canvas.addEventListener('wheel', (e) => {
      e.preventDefault();


      const rect = canvas.getBoundingClientRect();
      const offsetX = rect.left + translate.x * ratio;
      const offsetY = rect.top + translate.y * ratio;

      const centerX = canvas.width / 2;
      const centerY = canvas.height / 2;

      const mouseX = (Math.floor((e.pageX - offsetX) / ratio) - centerX);
      const mouseY = (Math.floor((e.pageY - offsetY) / ratio) - centerY);

      // const deltaX = translate.x - mouseX;
      // const deltaY = translate.y - mouseY;

      const factor = e.deltaY > 0 ? 0.9 : 1.1;
      // oldRatio = ratio;
      // ratio = Math.min(Math.max(ratio * factor, 16), 40);

      // const newMouseX = Math.floor((e.pageX - offsetX) / ratio) - centerX;
      // const newMouseY = Math.floor((e.pageY - offsetY) / ratio) - centerY;

      // const newDeltaX = translate.x - newMouseX;
      // const newDeltaY = translate.y - newMouseY;

      // // console.log(mouseX, mouseY)


      // ===================================================================


      // translate = { x: translate.x - mouseX, y: translate.y - mouseY };
      // oldRatio = ratio;
      // ratio = Math.min(Math.max(ratio * factor, 16), 40);
      // console.log(oldRatio, ratio, oldRatio / ratio)
      // translate = { 
      //   x: translate.x + (mouseX * factor), 
      //   y: translate.y + (mouseY * factor) 
      // };
      // renderCanvas();
      // renderOverlay();

      // ===================================================================


      // translate = { x: translate.x - mouseX, y: translate.y - mouseY };
      // renderCanvas();
      // renderOverlay();
      
      // ===================================================================
      
      // console.log(factor)

      if (ratio != 16) {
        ratio = 16;
        translate = { x: 0, y: 0 };
      }
      // else if (ratio == 16) {
      //   translate = { x: 0, y: 0 };
      //   const oldRatio = ratio;

      //   console.log('t1', translate)
      //   translate = { x: translate.x - mouseX, y: translate.y - mouseY };
      //   // translate = { x: translate.x - (mouseX * oldRatio / ratio), y: translate.y - (mouseY * oldRatio / ratio) };
        
      //   console.log('t2', translate)
      //   ratio = 25;
      //   translate = { x: translate.x + (mouseX * oldRatio / ratio), y: translate.y + (mouseY * oldRatio / ratio) };
      //   console.log('t3', translate)
      // }
      else {
        // translate = { x: 0, y: 0 };
        // console.log('t1', translate)
        const oldTranslate = translate;
        // translate = { x: -mouseX, y: -mouseY };
        // translate = { x: -24, y: -24 };
        // translate = { x: translate.x - (mouseX * oldRatio / ratio), y: translate.y - (mouseY * oldRatio / ratio) };
        // ratio = 40;
        const oldRatio = ratio;
        // ratio = Math.min(Math.max(ratio * factor, 16), 40);
        ratio = 40;
        
        // console.log('t2', translate)
        // translate = { x:  (translate.x + (mouseX - 16 * (factor))), y:  (translate.y + mouseY * (1 / factor)) };
        translate = { x: -mouseX + ((mouseX) * (oldRatio / ratio)), y: -mouseY + (mouseY * oldRatio / ratio) };
        // translate = { x: -2.19, y: -2.1818181818 };
        console.log('t3', mouseX, mouseY, translate, oldTranslate)
      } 
      renderCanvas();
      renderOverlay();
      // ratio = Math.min(Math.max(ratio * factor, 16), 40);
      
      // renderCanvas();
      // renderOverlay();

      // for (let i = 16; i < 25; i++) {
      //   setTimeout(() => {
      //     ratio = i;

      //     renderCanvas();
      //     renderOverlay();

      //   }, (i - 16) * 100)
      // }

      // setTimeout(() => {
      //   translate = { x: translate.x + (mouseX * oldRatio / ratio), y: translate.y + (mouseY * oldRatio / ratio) };
      //   renderCanvas();
      //   renderOverlay();

      //   }, 3000)

      // ===================================================================

      // translate = { x: translate.x + mouseX, y: translate.y + mouseY };
      // renderCanvas();
      // renderOverlay();

      // // const rect = canvas.getBoundingClientRect();
      // // const mouseX = Math.floor((e.pageX - rect.left) / ratio);
      // // const mouseY = Math.floor((e.pageY - rect.top) / ratio);
      // // const deltaX = dragStart.x - mouseX;
      // // const deltaY = dragStart.y - mouseY;

      // // translate = { x: translate.x - (newDeltaX - deltaX), y: translate.y - (newDeltaY - deltaY) };
      // translate = { x: translate.x + (deltaX * factor), y: translate.y + (deltaY * factor) };



      

      // translate = { x: -mouseX, y: -mouseY };
      // translate = { x: translate.x + mouseX * 0.9, y: translate.y + mouseY * 0.9 };

      // renderCanvas();
      // renderOverlay();
    });

    canvas.addEventListener('mousedown', (e) => {
      const rect = canvas.getBoundingClientRect();
      const mouseX = Math.floor((e.pageX - rect.left) / ratio);
      const mouseY = Math.floor((e.pageY - rect.top) / ratio);
      dragStart = { x: mouseX, y: mouseY };
      isDragging = true;
    });

    canvas.addEventListener('mousemove', (e) => {
      if (isDragging == true) {
        const rect = canvas.getBoundingClientRect();
        const mouseX = Math.floor((e.pageX - rect.left) / ratio);
        const mouseY = Math.floor((e.pageY - rect.top) / ratio);
        const deltaX = dragStart.x - mouseX;
        const deltaY = dragStart.y - mouseY;

        translate = { x: translate.x - deltaX, y: translate.y - deltaY };
        renderCanvas();
        renderOverlay();

        // const rect2 = canvas.getBoundingClientRect();
        // const mouseX2 = Math.floor((e.pageX - rect2.left) / ratio);
        // const mouseY2 = Math.floor((e.pageY - rect2.top) / ratio);
        // dragStart = { x: mouseX, y: mouseY };
        // // setTranslate(translate.x - deltaX, translate.y - deltaY);
      }
    });

    canvas.addEventListener('mouseup', () => {
      isDragging = false;
      console.log('stop move', translate)
    });



    fetch('/api/get', {
        method: 'GET',
        credentials: 'include', // This is equivalent to axios' withCredentials: true
      })
        .then((res) => {
          if (!res.ok) {
            throw new Error('Failed to fetch data');
          }
          return res.json(); // Parse the JSON data
        })
        .then((data) => {
          data.colors.forEach((c) => {
            const obj = {
              name: c['name'],
              color: `${c['red']}, ${c['green']}, ${c['blue']}`,
            };

            colors.set(c['id'], obj);
            setColor(obj, c['id'])
          });


          data.board.forEach((column, x) => {
            column.forEach((pixel, y) => {
              ctx.fillStyle = 'rgb(' + colors.get(pixel.color_id).color + ')';
              ctx.fillRect(x, y, 1, 1);
              board.set(`${x}:${y}`, pixel);
            });
          });
        })
        .catch((error) => {
          console.error('Error fetching data:', error);
        });


   
  });
</script>

</body>
</html>
